"use strict";var S=Object.defineProperty;var _=Object.getOwnPropertyDescriptor;var q=Object.getOwnPropertyNames,v=Object.getOwnPropertySymbols;var M=Object.prototype.hasOwnProperty,B=Object.prototype.propertyIsEnumerable;var D=i=>{throw TypeError(i)};var P=(i,e,t)=>e in i?S(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,A=(i,e)=>{for(var t in e||(e={}))M.call(e,t)&&P(i,t,e[t]);if(v)for(var t of v(e))B.call(e,t)&&P(i,t,e[t]);return i};var G=(i,e)=>{for(var t in e)S(i,t,{get:e[t],enumerable:!0})},F=(i,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of q(e))!M.call(i,s)&&s!==t&&S(i,s,{get:()=>e[s],enumerable:!(r=_(e,s))||r.enumerable});return i};var J=i=>F(S({},"__esModule",{value:!0}),i);var O=(i,e,t)=>e.has(i)||D("Cannot "+t);var n=(i,e,t)=>(O(i,e,"read from private field"),t?t.call(i):e.get(i)),m=(i,e,t)=>e.has(i)?D("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(i):e.set(i,t),d=(i,e,t,r)=>(O(i,e,"write to private field"),r?r.call(i,t):e.set(i,t),t);var l=(i,e,t)=>new Promise((r,s)=>{var o=u=>{try{f(t.next(u))}catch(y){s(y)}},h=u=>{try{f(t.throw(u))}catch(y){s(y)}},f=u=>u.done?r(u.value):Promise.resolve(u.value).then(o,h);f((t=t.apply(i,e)).next())});var Y={};G(Y,{EntitiesClient:()=>T,EntityClient:()=>E,LumiAuthClient:()=>w,LumiClient:()=>I,createClient:()=>V});module.exports=J(Y);var $=require("uuid");var k=require("ofetch");function c(i,e,t={}){return i.auth.accessToken&&(t.headers=A({Authorization:`Bearer ${i.auth.accessToken}`},t.headers)),(0,k.ofetch)(e,A({baseURL:i.config.apiBaseUrl},t))}function N(){var i,e;return(e=(i=document.querySelector('link[rel="icon"]'))==null?void 0:i.href)!=null?e:null}function U(){var i;return(i=document.title)!=null?i:null}function x(i,e,t=localStorage){let r=t.getItem(i),s=e?JSON.stringify(e):null;s?t.setItem(i,s):t.removeItem(i),window.dispatchEvent(new StorageEvent("storage",{key:i,oldValue:r,newValue:s,storageArea:t}))}function L(i,e=localStorage){let t=e.getItem(i);try{return t?JSON.parse(t):null}catch(r){return null}}var g,C,w=class{constructor(e){m(this,g);m(this,C,`lumi-auth-${(0,$.v4)()}`);d(this,g,e)}get accessToken(){return L("lumi-access-token")}set accessToken(e){x("lumi-access-token",e)}get user(){return L("lumi-user")}set user(e){x("lumi-user",e)}get isAuthenticated(){return!!this.accessToken}signIn(){let r=(window.screen.width-800)/2,s=(window.screen.height-600)/2,o=window.open(n(this,g).config.authOrigin,n(this,C),`width=800,height=600,left=${r},top=${s}`),h;return new Promise((f,u)=>{if(!o)return u(new Error("Open auth window failed"));let y=setInterval(()=>{o.closed&&u(new Error("Auth window closed"))},1e3),R=({data:p,origin:j,source:K})=>{if(!(j!==n(this,g).config.authOrigin||K!==o))switch(p==null?void 0:p.type){case"lumi-ready":{o.postMessage({type:"lumi-init",data:{projectId:n(this,g).config.projectId,icon:N(),title:U()}},n(this,g).config.authOrigin);break}case"lumi-sign-in":{if(p.data.projectId!==n(this,g).config.projectId)break;o.close(),window.focus(),this.accessToken=p.data.accessToken,this.user=p.data.user,f(p.data);break}}};window.addEventListener("message",R),h=()=>{clearInterval(y),window.removeEventListener("message",R)}}).finally(()=>h==null?void 0:h())}signOut(){this.accessToken=null,this.user=null}refreshUser(){return l(this,null,function*(){let e=yield c(n(this,g),"/lm/user/info",{method:"POST"});if(e.code!==200)throw new Error(e.message);return this.user=e.data,e.data})}onAuthChange(e){let t=r=>{(r.key==="lumi-access-token"||r.key==="lumi-user"||r.key===null)&&e({isAuthenticated:this.isAuthenticated,user:this.user})};return window.addEventListener("storage",t),()=>{window.removeEventListener("storage",t)}}};g=new WeakMap,C=new WeakMap;var a,E=class{constructor(e,t){m(this,a);d(this,a,e),this.entityName=t}list(){return l(this,arguments,function*({filter:e,sort:t,limit:r,skip:s}={}){if(r){let o=yield c(n(this,a),this.uri("/find"),{method:"POST",body:{filter:e,sort:t,limit:r,skip:s}});if(o.code!==200)throw new Error(o.message);return o.data}else{let o=yield c(n(this,a),this.uri("/list"),{method:"POST",body:{filter:e,sort:t}});if(o.code!==200)throw new Error(o.message);return{total:o.data.length,list:o.data}}})}get(e){return l(this,null,function*(){let t=yield c(n(this,a),this.uri(`/${e}`),{method:"GET"});if(t.code!==200)throw new Error(t.message);return t.data})}create(e){return l(this,null,function*(){let t=yield c(n(this,a),this.uri(),{method:"POST",body:e});if(t.code!==200)throw new Error(t.message);return t.data})}createMany(e){return l(this,null,function*(){let t=yield c(n(this,a),this.uri("/batch"),{method:"POST",body:e});if(t.code!==200)throw new Error(t.message);return t.data})}update(e,t){return l(this,null,function*(){let r=yield c(n(this,a),this.uri(),{method:"PUT",body:{filter:{_id:e},update:t}});if(r.code!==200)throw new Error(r.message);return r.data})}delete(e){return l(this,null,function*(){let t=yield c(n(this,a),this.uri(`/${e}`),{method:"DELETE"});if(t.code!==200)throw new Error(t.message)})}deleteMany(e){return l(this,null,function*(){let t=yield c(n(this,a),this.uri("/batch-by-ids"),{method:"DELETE",params:{ids:e}});if(t.code!==200)throw new Error(t.message)})}uri(e=""){return`/lm/${n(this,a).config.projectId}/${this.entityName}/documents${e}`}};a=new WeakMap;var b,T=class{constructor(e){m(this,b);return d(this,b,e),new Proxy(this,{get(t,r){return r in t||(t[r]=new E(n(t,b),r)),t[r]}})}};b=new WeakMap;var I=class{constructor(e){this.config=e,this.auth=new w(this),this.entities=new T(this)}};function V(i){return new I(i)}0&&(module.exports={EntitiesClient,EntityClient,LumiAuthClient,LumiClient,createClient});
//# sourceMappingURL=index.js.map